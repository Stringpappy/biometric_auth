<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register with WebAuthn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- CSRF token for Django -->
  <meta name="csrf-token" content="{{ csrf_token }}">

  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet">
</head>
<body class="bg-light text-dark">
  <div class="container mt-5">
    <div class="card shadow-lg p-4">
      <h2 class="mb-3 text-center">WebAuthn Registration</h2>
      <div class="mb-3">
        <label for="username" class="form-label">Enter Username</label>
        <input type="text" id="username" class="form-control" placeholder="e.g. johndoe">
      </div>
      <div class="d-grid">
        <button class="btn btn-primary" onclick="startWebAuthnRegister()">Register with Biometrics</button>
      </div>
      <div id="message" class="mt-3 text-center"></div>
    </div>
  </div>

  <script>
    async function startWebAuthnRegister() {
      const username = document.getElementById('username').value.trim();
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = '';

      if (!username) {
        messageDiv.textContent = 'Please enter a username.';
        return;
      }

      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      try {
        // Step 1: Get registration options from server
        const res = await fetch('/start-webauthn-register/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({ username }),
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('Server responded with HTML or error:', errorText);
          throw new Error("Server error or bad response format.");
        }

        const options = await res.json();

        // Decode base64url to ArrayBuffers
        options.challenge = base64urlToBuffer(options.challenge);
        options.user.id = base64urlToBuffer(options.user.id);

        // Step 2: Create credentials using browser
        const credential = await navigator.credentials.create({ publicKey: options });

        if (credential) {
          messageDiv.textContent = 'Registration successful! Now send this to your backend to save it.';
          console.log('New credential:', credential);
          // TODO: Send credential.response to your backend for verification
        }

      } catch (err) {
        console.error(err);
        messageDiv.textContent = `Error: ${err.message}`;
      }
    }

    function base64urlToBuffer(base64url) {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/') + padding;
      const str = atob(base64);
      const bytes = new Uint8Array(str.length);
      for (let i = 0; i < str.length; i++) {
        bytes[i] = str.charCodeAt(i);
      }
      return bytes.buffer;
    }
  </script>
</body>
</html>
