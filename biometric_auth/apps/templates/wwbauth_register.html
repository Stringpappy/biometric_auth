<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebAuthn Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet">
</head>
<body class="bg-dark text-white">
  <div class="container mt-5">
    <div class="card p-4 bg-secondary">
      <h2 class="text-center mb-4">Register Fingerprint (WebAuthn)</h2>
      <form id="webauthnForm">
        <div class="mb-3">
          <label for="username" class="form-label">Username:</label>
          <input type="text" class="form-control" id="username" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Start WebAuthn Registration</button>
      </form>
      <div id="responseMessage" class="mt-3 text-center"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('webauthnForm');
    const responseMessage = document.getElementById('responseMessage');

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
      const len = binary.length;
      const buffer = new ArrayBuffer(len);
      const view = new Uint8Array(buffer);
      for (let i = 0; i < len; i++) {
        view[i] = binary.charCodeAt(i);
      }
      return buffer;
    }

    function decodeOptions(options) {
      options.challenge = base64ToArrayBuffer(options.challenge);
      options.user.id = base64ToArrayBuffer(options.user.id);
      return options;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;

      try {
        // Step 1: Get WebAuthn registration options from backend
        const res = await fetch('http://127.0.0.1:8000/start_webauthn_register/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });

        const options = await res.json();
        decodeOptions(options);

        // Step 2: Call WebAuthn API
        const credential = await navigator.credentials.create({ publicKey: options });

        // Step 3: Show success
        console.log("Credential:", credential);
        responseMessage.innerHTML = `<div class="alert alert-success">WebAuthn registration complete. Send credential to backend for verification (not implemented here).</div>`;
      } catch (err) {
        console.error(err);
        responseMessage.innerHTML = `<div class="alert alert-danger">Registration failed: ${err.message}</div>`;
      }
    });
  </script>
</body>
</html>
